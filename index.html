<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Scratch Extensions : Extensions for Scratch 2.0">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Scratch Extensions</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/LLK/scratch-extensions">View on GitHub</a>

          <h1 id="project_title">Scratch Extensions</h1>
          <h2 id="project_tagline">Extensions for Scratch 2.0</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/LLK/scratch-extensions/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/LLK/scratch-extensions/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="writing-extensions-for-scratch-20" class="anchor" href="#writing-extensions-for-scratch-20"><span class="octicon octicon-link"></span></a>Writing Extensions for Scratch 2.0</h1>

<p>Writing a Javascript extension for Scratch 2.0 starts with some boilerplate code, which looks like the following:</p>

<div class="highlight highlight-javascript"><pre><span class="k">new</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="c1">// Cleanup function when the extension is unloaded</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

    <span class="c1">// Status reporting code</span>
    <span class="c1">// Use this to report missing hardware, plugin or unsupported browser</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_getStatus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Ready'</span><span class="p">};</span>
    <span class="p">};</span>

    <span class="c1">// Block and block menu descriptions</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">blocks</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">]</span>
    <span class="p">};</span>

    <span class="c1">// Register the extension</span>
    <span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Sample extension'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>

<h2>
<a name="adding-blocks" class="anchor" href="#adding-blocks"><span class="octicon octicon-link"></span></a>Adding Blocks</h2>

<p>An extension may define a number of blocks, of different types (e.g. a command block, or a hat block, or a reporter block). Blocks can take in parameters.</p>

<h3>
<a name="command-blocks" class="anchor" href="#command-blocks"><span class="octicon octicon-link"></span></a>Command blocks</h3>

<p>To add a simple <em>command</em> block, there needs to be an entry in the <code>descriptors.blocks</code> list, and a corresponding function for it. The simplest block possible is shown below (it does nothing).</p>

<div class="highlight highlight-javascript"><pre><span class="k">new</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="c1">// Cleanup function when the extension is unloaded</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

    <span class="c1">// Status reporting code</span>
    <span class="c1">// Use this to report missing hardware, plugin or unsupported browser</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_getStatus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Ready'</span><span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">ext</span><span class="p">.</span><span class="nx">my_first_block</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Code that gets executed when the block is run</span>
    <span class="p">};</span>

    <span class="c1">// Block and block menu descriptions</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">blocks</span><span class="o">:</span> <span class="p">[</span>
            <span class="c1">// Block type, block name, function name</span>
            <span class="p">[</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">'my first block'</span><span class="p">,</span> <span class="s1">'my_first_block'</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">};</span>

    <span class="c1">// Register the extension</span>
    <span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'My first extension'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>

<h3>
<a name="command-blocks-that-wait" class="anchor" href="#command-blocks-that-wait"><span class="octicon octicon-link"></span></a>Command blocks that wait</h3>

<p>Sometimes it is necessary to have a command block that waits (e.g. if a block plays a sound, it may be a good idea to wait till the sound playback finishes). The sample extension below implements a "random wait" block to show how that can be done. Note the use of the <code>console.log</code> statement in the code - most Javascript methods, as well as <a href="http://jquery.com/">jQuery</a> methods will work fine in an extension.</p>

<div class="highlight highlight-javascript"><pre><span class="k">new</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="c1">// Cleanup function when the extension is unloaded</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

    <span class="c1">// Status reporting code</span>
    <span class="c1">// Use this to report missing hardware, plugin or unsupported browser</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_getStatus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Ready'</span><span class="p">};</span>
    <span class="p">};</span>

    <span class="c1">// Functions for block with type 'w' will get a callback function as the </span>
    <span class="c1">// final argument. This should be called to indicate that the block can</span>
    <span class="c1">// stop waiting.</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">wait_random</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">wait</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Waiting for '</span> <span class="o">+</span> <span class="nx">wait</span> <span class="o">+</span> <span class="s1">' seconds'</span><span class="p">);</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">();</span>
        <span class="p">},</span> <span class="nx">wait</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="c1">// Block and block menu descriptions</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">blocks</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">'w'</span><span class="p">,</span> <span class="s1">'wait for random time'</span><span class="p">,</span> <span class="s1">'wait_random'</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">};</span>

    <span class="c1">// Register the extension</span>
    <span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Random wait extension'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>

<h3>
<a name="reporter-blocks" class="anchor" href="#reporter-blocks"><span class="octicon octicon-link"></span></a>Reporter blocks</h3>

<p>Blocks can also return values, and they are called <em>reporter</em> blocks. The corresponding JavaScript function for a reporter block needs to return a value, as shown in the example below (note that this example also shows how to make blocks accept parameters).</p>

<div class="highlight highlight-javascript"><pre><span class="k">new</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="c1">// Cleanup function when the extension is unloaded</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

    <span class="c1">// Status reporting code</span>
    <span class="c1">// Use this to report missing hardware, plugin or unsupported browser</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_getStatus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Ready'</span><span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">ext</span><span class="p">.</span><span class="nx">power</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">exponent</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">exponent</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="c1">// Block and block menu descriptions</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">blocks</span><span class="o">:</span> <span class="p">[</span>
            <span class="c1">// Block type, block name, function name, param1 default value, param2 default value</span>
            <span class="p">[</span><span class="s1">'r'</span><span class="p">,</span> <span class="s1">'%n ^ %n'</span><span class="p">,</span> <span class="s1">'power'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">};</span>

    <span class="c1">// Register the extension</span>
    <span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Sample extension'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>

<h3>
<a name="reporter-blocks-that-wait" class="anchor" href="#reporter-blocks-that-wait"><span class="octicon octicon-link"></span></a>Reporter blocks that wait</h3>

<p>One common use-case for reporter blocks is getting data from online web-services, where the blocks need to wait for the web-api call to complete. The following example shows how to fetch the current temperature of a city using an AJAX call to <a href="http://openweathermap.org/API">Open Weather Map API</a>. Note that the block type is <em>R</em> instead of <em>r</em> (which is for a non-blocking reporter).</p>

<div class="highlight highlight-javascript"><pre><span class="k">new</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="c1">// Cleanup function when the extension is unloaded</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

    <span class="c1">// Status reporting code</span>
    <span class="c1">// Use this to report missing hardware, plugin or unsupported browser</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_getStatus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Ready'</span><span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">ext</span><span class="p">.</span><span class="nx">get_temp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Make an AJAX call to the Open Weather Maps API</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
              <span class="nx">url</span><span class="o">:</span> <span class="s1">'http://api.openweathermap.org/data/2.5/weather?q='</span><span class="o">+</span><span class="nx">location</span><span class="o">+</span><span class="s1">'&amp;units=imperial'</span><span class="p">,</span>
              <span class="nx">dataType</span><span class="o">:</span> <span class="s1">'jsonp'</span><span class="p">,</span>
              <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">weather_data</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// Got the data - parse it and return the temperature</span>
                  <span class="nx">temperature</span> <span class="o">=</span> <span class="nx">weather_data</span><span class="p">[</span><span class="s1">'main'</span><span class="p">][</span><span class="s1">'temp'</span><span class="p">];</span>
                  <span class="nx">callback</span><span class="p">(</span><span class="nx">temperature</span><span class="p">);</span>
              <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="c1">// Block and block menu descriptions</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">blocks</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'current temperature in city %s'</span><span class="p">,</span> <span class="s1">'get_temp'</span><span class="p">,</span> <span class="s1">'Boston, MA'</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">};</span>

    <span class="c1">// Register the extension</span>
    <span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Weather extension'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>

<h3>
<a name="hat-blocks" class="anchor" href="#hat-blocks"><span class="octicon octicon-link"></span></a>Hat blocks</h3>

<p>Hat blocks go on top of block stacks - examples of Scratch hat blocks include "when green flag clicked" or "when this sprite clicked". To create a hat block through an extension, the block type needs to be set to <em>h</em>, as shown in the example below.</p>

<div class="highlight highlight-javascript"><pre><span class="k">new</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ext</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">alarm_went_off</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// This becomes true after the alarm goes off</span>

    <span class="c1">// Cleanup function when the extension is unloaded</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

    <span class="c1">// Status reporting code</span>
    <span class="c1">// Use this to report missing hardware, plugin or unsupported browser</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">_getStatus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Ready'</span><span class="p">};</span>
    <span class="p">};</span>

    <span class="nx">ext</span><span class="p">.</span><span class="nx">set_alarm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
       <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
           <span class="nx">alarm_went_off</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
       <span class="p">},</span> <span class="nx">time</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">ext</span><span class="p">.</span><span class="nx">when_alarm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
       <span class="c1">// Reset alarm_went_off if it is true, and return true</span>
       <span class="c1">// otherwise, return false.</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">alarm_went_off</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">alarm_went_off</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
           <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
       <span class="p">}</span>

       <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">// Block and block menu descriptions</span>
    <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">blocks</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="s1">'run alarm after %n seconds'</span><span class="p">,</span> <span class="s1">'set_alarm'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">'h'</span><span class="p">,</span> <span class="s1">'when alarm goes off'</span><span class="p">,</span> <span class="s1">'when_alarm'</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">};</span>

    <span class="c1">// Register the extension</span>
    <span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Alarm extension'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">);</span>
<span class="p">})();</span>
</pre></div>

<h2>
<a name="hardware-support" class="anchor" href="#hardware-support"><span class="octicon octicon-link"></span></a>Hardware Support</h2>

<p>Scratch provides its own set of APIs in order to allow extensions to access certain types of hardware. Currently, Scratch extensions may access the following types of hardware:</p>

<ul>
<li>Serial devices such as the PicoBoard</li>
<li>USB HID devices such as joysticks or the LEGO WeDo</li>
</ul><p>Extensions that request hardware access are required to implement two additional methods on the extension instance: <code>_deviceConnected()</code> and <code>_deviceRemoved()</code>. Both methods receive a device instance. To use the integrated hardware functions of the Scratch Extension API you pass the hardware information in the registration call:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Example Name'</span><span class="p">,</span> <span class="nx">descriptor_object</span><span class="p">,</span> <span class="nx">ext_instance</span><span class="p">[,</span> <span class="nx">hardware_info</span><span class="p">]);</span>
</pre></div>

<p>The <code>_getStatus()</code> method of your extension can be used to indicate whether your extension has successfully communicated with a hardware device. For example:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ext</span><span class="p">.</span><span class="nx">_getStatus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">device</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Device not connected'</span><span class="p">};</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">status</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Device connected'</span><span class="p">};</span>
<span class="p">}</span>
</pre></div>

<p>The value returned by <code>_getStatus()</code> corresponds to the color of the status 'light' in Scratch and indicates the general state of your extension. The <code>msg</code> property can be used to provide more specific information.</p>

<table>
<thead><tr>
<th>Value</th>
<th>Color</th>
<th>Meaning</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>red</td>
<td>error</td>
</tr>
<tr>
<td>1</td>
<td>yellow</td>
<td>not ready</td>
</tr>
<tr>
<td>2</td>
<td>green</td>
<td>ready</td>
</tr>
</tbody>
</table><p>The details of the <code>hardware_info</code> parameter and the <code>_deviceConnected()</code> and <code>_deviceRemoved()</code> methods are described below in sections specific to each type of device.</p>

<p><em><em>API Note: The hardware API is still somewhat experimental and may change in the future. In particular, we will soon be making a change to methods that return hardware data, such as <code>read()</code> for HID devices: these methods will take a callback in instead of returning data directly. This change is necessary to improve compatibility and allow us to expand the variety of environments in which hardware extensions are available.</em></em></p>

<h3>
<a name="usb-hid-support" class="anchor" href="#usb-hid-support"><span class="octicon octicon-link"></span></a>USB HID Support</h3>

<p><em>An example HID device extension is available <a href="http://scratch.mit.edu/scratchr2/static/js/scratch_extensions/sixaxisExtension.js">here</a>.</em>
<em>More information about the HID protocol is available <a href="http://www.usb.org/developers/devclass_docs/HID1_11.pdf">here</a>.</em></p>

<p>To let the extension system know that your extension is interested in USB HID devices, pass an object like this for the <code>hardware_info</code> parameter of the <code>register()</code> method:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">hid_info</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">'hid'</span><span class="p">,</span> <span class="nx">vendor</span><span class="o">:</span> <span class="mh">0x0694</span><span class="p">,</span> <span class="nx">product</span><span class="o">:</span> <span class="mh">0x0003</span><span class="p">};</span>
<span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Example'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">hid_info</span><span class="p">);</span>
</pre></div>

<p>The <code>vendor</code> and <code>product</code> values indicate the USB vendor and product ID of the device your extension supports. These values are frequently expressed as four-digit hexadecimal values, as indicated with the <code>0x</code> prefix in the JavaScript above.</p>

<p>If a device is connected with matching vendor and product IDs, Scratch will call the <code>_deviceConnected()</code> method on your extension and pass an object representing that device. Your <code>_deviceConnected()</code> method should keep track of the device object and set up communication as necessary for your needs. For example, this will start polling the device for new HID data every 20 milliseconds:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">poller</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nx">ext</span><span class="p">.</span><span class="nx">_deviceConnected</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">device</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">device</span> <span class="o">=</span> <span class="nx">dev</span><span class="p">;</span>
    <span class="nx">device</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span>

    <span class="nx">poller</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">rawData</span> <span class="o">=</span> <span class="nx">device</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
    <span class="p">},</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

<p>Once a connection to your device is established, your extension may use the <code>read()</code> and <code>write()</code> methods on the device object to communicate with it. These methods use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays">ArrayBuffer</a> objects to contain data being sent or received.</p>

<ul>
<li>
<code>device.read(48)</code> will attempt to read 48 bytes of data and return an ArrayBuffer containing any data successfully read. Note that one packet of HID data is 48 bytes. <em><em>This method is likely to change soon. See the API Note above.</em></em>
</li>
<li>
<code>device.write(buffer)</code> will send the given ArrayBuffer's data to the device.</li>
</ul><p>Your extension will also be notified if a matching device is disconnected, allowing your extension a chance to stop communication:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ext</span><span class="p">.</span><span class="nx">_deviceRemoved</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">device</span> <span class="o">!=</span> <span class="nx">dev</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">poller</span><span class="p">)</span> <span class="nx">poller</span> <span class="o">=</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">poller</span><span class="p">);</span>
    <span class="nx">device</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>Finally, your extension's <code>_shutdown()</code> method will be executed when the extension itself is shut down. For example:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">poller</span><span class="p">)</span> <span class="nx">poller</span> <span class="o">=</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">poller</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">device</span><span class="p">)</span> <span class="nx">device</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="nx">device</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h3>
<a name="serial-device-support" class="anchor" href="#serial-device-support"><span class="octicon octicon-link"></span></a>Serial Device Support</h3>

<p><em>An example serial device extension is available <a href="http://scratch.mit.edu/scratchr2/static/js/scratch_extensions/picoExtension.js">here</a>.</em></p>

<p>To let the extension system know that your extension is interested in serial devices, pass an object like this for the <code>hardware_info</code> parameter of the <code>register()</code> method:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">serial_info</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="s1">'serial'</span><span class="p">};</span>
<span class="nx">ScratchExtensions</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'Example'</span><span class="p">,</span> <span class="nx">descriptor</span><span class="p">,</span> <span class="nx">ext</span><span class="p">,</span> <span class="nx">serial_info</span><span class="p">);</span>
</pre></div>

<p>Your extension's <code>_deviceConnected()</code> method will be called for each serial port present on the computer. Your extension is responsible for checking if a suitable device is attached to that port and continuing on to the next port if necessary. Do not assume that the first time Scratch calls your <code>_deviceConnected()</code> will correspond to your device's serial port. The PicoBoard extension shows an example of how to deal with this situation: if no valid PicoBoard communication is received on a given port withing a particular timeout, the extension assumes that there is no PicoBoard on that port and continues scanning to the next port.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">potentialDevices</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">ext</span><span class="p">.</span><span class="nx">_deviceConnected</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">potentialDevices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">device</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tryNextDevice</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>To communicate with a given serial port, your extension should open it with whichever options are appropriate for your device. These parameters are based on <a href="http://www.boost.org/doc/libs/1_50_0/doc/html/boost_asio/reference/serial_port_base.html">Boost.Asio's serial port options</a>. For a PicoBoard:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">device</span><span class="p">.</span><span class="nx">open</span><span class="p">({</span> <span class="nx">stopBits</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">bitRate</span><span class="o">:</span> <span class="mi">38400</span><span class="p">,</span> <span class="nx">ctsFlowControl</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
</pre></div>

<p>The full set of options available for a serial port are as follows:</p>

<table>
<thead><tr>
<th>Option</th>
<th>Default</th>
<th>Valid values</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td>bitRate</td>
<td>9600</td>
<td>Any valid baud rate</td>
<td>Up to  The bit (or baud) rate at which to communicate.</td>
</tr>
<tr>
<td>bufferSize</td>
<td>4096</td>
<td>Up to 8192</td>
<td>The maximum amount of data that can be received at a time.</td>
</tr>
<tr>
<td>ctsFlowControl</td>
<td>1 (software)</td>
<td>0 (none), 1 (software), 2 (hardware)</td>
<td>The type of flow control to use.</td>
</tr>
<tr>
<td>dataBits</td>
<td>8</td>
<td>5, 6, 7, 8</td>
<td>The number of data bits per character.</td>
</tr>
<tr>
<td>parityBit</td>
<td>0 (none)</td>
<td>0 (none), 1 (odd), 2 (even)</td>
<td>Whether and how to use the parity bit in each character.</td>
</tr>
<tr>
<td>stopBits</td>
<td>1 (1.5 bits)</td>
<td>0 (1 bit), 1 (1.5 bits), 2 (2 bits)</td>
<td>The number of stop bits per character.</td>
</tr>
</tbody>
</table><p>Once a connection to your device is established, your extension may use the <code>send()</code> method to send data to your device, and the <code>set_receive_handler()</code> method to register a function to handle received data. These methods use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Typed_arrays">ArrayBuffer</a> objects to contain data being sent or received.</p>

<ul>
<li>
<code>device.send(buffer)</code> will send the given ArrayBuffer's data to the device.</li>
<li>
<code>device.set_receive_handler(myReceiveHandler)</code> will result in <code>myReceiveHandler(buffer)</code> being called any time Scratch receives data from the device. Your receive handler will be supplied an ArrayBuffer containing the received data.</li>
</ul><p>Your extension will also be notified if a device is disconnected, allowing your extension a chance to stop communication:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ext</span><span class="p">.</span><span class="nx">_deviceRemoved</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dev</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">device</span> <span class="o">!=</span> <span class="nx">dev</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">poller</span><span class="p">)</span> <span class="nx">poller</span> <span class="o">=</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">poller</span><span class="p">);</span>
    <span class="nx">device</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>

<p>Finally, your extension's <code>_shutdown()</code> method will be executed when the extension itself is shut down. For example:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">ext</span><span class="p">.</span><span class="nx">_shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">poller</span><span class="p">)</span> <span class="nx">poller</span> <span class="o">=</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">poller</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">device</span><span class="p">)</span> <span class="nx">device</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="nx">device</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Scratch Extensions maintained by <a href="https://github.com/LLK">LLK</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
